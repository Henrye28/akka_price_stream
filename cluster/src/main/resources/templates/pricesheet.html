<HTML xmlns:th="http://www.w3.org/1999/xhtml">
<HEAD>
    <TITLE> Add/Remove dynamic rows in HTML table </TITLE>
    <script type="text/javascript" th:src="@{/js/stomp.js}"></script>
    <script type="text/javascript" th:src="@{/js/sockjs-0.3.4.js}"></script>
    <link th:href="@{/styles/color.css}" rel="stylesheet" />
    <SCRIPT src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></SCRIPT>
    <SCRIPT language="javascript" >

        function connect(coin) {
            var socket = new SockJS('/pricecoin');
            stompClient = Stomp.over(socket);
            console.log('Connecting to queue /queue/' + coin);
            stompClient.connect({}, function(frame) {
                console.log('Socket Connected: ' + frame);
                stompClient.subscribe('/queue/' + coin, function(message) {
                    console.log('Message received: ' + message.body + ' for coin: ' + coin);
                    var result = (Math.round(message.body * 100) / 100).toFixed(3);
                    showMessage(result, coin);
                });
            });
        }

        function showMessage(message, coin) {
            var row = document.getElementById(coin);
            var priceCell = row.cells[3]

            priceCell.style.backgroundColor='lightgreen';
            setTimeout(function() {
                priceCell.style.backgroundColor='#ffffff'
            }, 500);

            priceCell.innerHTML = message
        }

        function clickButton(){
            var coin = ''
            var quantity = ''
            var priceTable = document.getElementById('priceTable');
            // LOOP THROUGH EACH ROW OF THE TABLE AFTER HEADER.
            for (i = 1; i < priceTable.rows.length; i++) {
                // GET THE CELLS COLLECTION OF THE CURRENT ROW.
                var objCells = priceTable.rows.item(i).cells;
                coin = coin + ',' + objCells[1].children[0].value
                quantity = quantity + ',' + objCells[2].children[0].value
            }

            $.ajax({
                    type:"post",
                    url:"/price/underlying",
                    data:
                    {
                       'coin':coin,
                       'quantity':quantity
                    },
                    cache:false,
                    success: function (html)
                    {
                       console.log('Underlyings Refreshed');
                       $('#msg').html(html);
                    }
            });

            connect('btc');
            connect('eth');
            connect('dot');
            connect('ada');
            connect('link');
            return false;
        }
	</SCRIPT>
</HEAD>
<BODY>

<!--<FORM action="/underlying" method="post">-->
<TABLE id="priceTable" width="350px" border="1">
    <TR>
        <TH> </TH>
        <TH>Coin</TH>
        <TH>Quantity</TH>
        <TH>Price</TH>
    </TR>
    <TR id = "btc">
        <TD> <INPUT type="checkbox" name="chk"/></TD>
        <TD> <INPUT value="BTC" type="text" name="coin"/> </TD>
        <TD> <INPUT value=" " type="text" name="quantity"/> </TD>
        <TD> <INPUT type="text" name="price" readonly/> </TD>
    </TR>
    <TR id = "eth">
        <TD> <INPUT type="checkbox" name="chk"/></TD>
        <TD> <INPUT value="ETH" type="text" name="coin"/> </TD>
        <TD> <INPUT value=" " type="text" name="quantity"/> </TD>
        <TD> <INPUT type="text" name="price" readonly/> </TD>
    </TR>
    <TR id = "dot">
        <TD> <INPUT type="checkbox" name="chk"/></TD>
        <TD> <INPUT value="DOT" type="text" name="coin"/> </TD>
        <TD> <INPUT value=" " type="text" name="quantity"/> </TD>
        <TD> <INPUT type="text" name="price" readonly/> </TD>
    </TR>
    <TR id = "ada">
        <TD> <INPUT type="checkbox" name="chk"/></TD>
        <TD> <INPUT value="ADA" type="text" name="coin"/> </TD>
        <TD> <INPUT value=" " type="text" name="quantity"/> </TD>
        <TD> <INPUT type="text" name="price" readonly/> </TD>
    </TR>
    <TR id = "link">
        <TD> <INPUT type="checkbox" name="chk"/></TD>
        <TD> <INPUT value="LINK" type="text" name="coin"/> </TD>
        <TD> <INPUT value=" " type="text" name="quantity"/> </TD>
        <TD> <INPUT type="text" name="price" readonly/> </TD>
    </TR>
</TABLE>
<input type="button" value="refresh underlyings" onclick="clickButton()">
<!--</FORM>-->

</BODY>
</HTML>